<!-- ADD THIS OLLAMA CHAT PANEL TO YOUR index.html -->

<!-- Ollama Chat Interface -->
<div class="panel" id="ollama-chat-panel">
    <div class="panel-title">üí¨ Ollama AI Chat</div>
    
    <div id="ollama-chat-status" style="margin-bottom: 10px; padding: 10px; background: rgba(0, 40, 0, 0.5); border: 1px solid #0f0; border-radius: 3px;">
        <div id="ollama-connection-status">
            <span style="opacity: 0.7;">Not connected</span>
        </div>
        <div id="ollama-model-select" style="display: none; margin-top: 10px;">
            <label style="display: block; margin-bottom: 5px; font-size: 12px;">Model:</label>
            <select id="ollama-model-dropdown" style="width: 100%; padding: 5px; background: #001a00; color: #0f0; border: 1px solid #0f0; border-radius: 3px;">
                <option value="llama3">Llama 3</option>
                <option value="mistral">Mistral</option>
                <option value="codellama">Code Llama</option>
            </select>
        </div>
    </div>

    <div id="ollama-chat-messages" style="height: 300px; overflow-y: auto; padding: 10px; background: rgba(0, 20, 0, 0.5); border: 1px solid #0f0; border-radius: 3px; margin-bottom: 10px; font-size: 13px; line-height: 1.6;">
        <div style="text-align: center; opacity: 0.5; padding: 20px;">
            Connect to Ollama to start chatting with AI...
        </div>
    </div>

    <div style="display: flex; gap: 5px;">
        <input 
            type="text" 
            id="ollama-chat-input" 
            placeholder="Ask Ollama anything..." 
            style="flex: 1; padding: 10px; background: #001a00; color: #0f0; border: 1px solid #0f0; border-radius: 3px; font-family: 'Courier New', monospace;"
            disabled
        />
        <button 
            class="btn" 
            id="ollama-send-btn" 
            onclick="sendOllamaMessage()" 
            style="padding: 10px 20px;"
            disabled
        >
            SEND
        </button>
    </div>

    <div style="margin-top: 10px; font-size: 11px; opacity: 0.6;">
        üí° Tip: Ask about coding, gaming, or anything!
    </div>
</div>

<script>
// Ollama Chat System
let ollamaMessages = [];
let currentOllamaModel = 'llama3';

// Connect to Ollama and enable chat
async function connectOllama() {
    log('Connecting to Ollama...', 'info');
    
    try {
        const response = await fetch('/api/ollama/connect', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            log('Ollama connected!', 'info');
            
            // Update status
            document.getElementById('ollama-connection-status').innerHTML = `
                <div style="color: #0f0;">‚úÖ <strong>Connected</strong></div>
                <div style="font-size: 11px; margin-top: 5px;">
                    ${data.models.length} models available
                </div>
            `;
            
            // Show model selector
            document.getElementById('ollama-model-select').style.display = 'block';
            
            // Populate models
            const select = document.getElementById('ollama-model-dropdown');
            select.innerHTML = data.models.map(m => 
                `<option value="${m.name}">${m.name}</option>`
            ).join('');
            
            // Enable chat
            document.getElementById('ollama-chat-input').disabled = false;
            document.getElementById('ollama-send-btn').disabled = false;
            
            // Clear welcome message
            document.getElementById('ollama-chat-messages').innerHTML = `
                <div style="text-align: center; opacity: 0.7; padding: 10px; border-bottom: 1px solid rgba(0, 255, 0, 0.3);">
                    ü§ñ Ollama AI connected! Start chatting...
                </div>
            `;
            
            // Update models display
            const modelsList = data.models.map(m => m.name).join(', ');
            document.getElementById('ollama-models').innerHTML = `
                <strong>Connected</strong><br>
                Models: ${modelsList}
            `;
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        log(`Failed to connect: ${error.message}`, 'error');
        
        document.getElementById('ollama-connection-status').innerHTML = `
            <div style="color: #ff0;">‚ö†Ô∏è <strong>Not Running</strong></div>
            <div style="font-size: 11px; margin-top: 5px;">
                Start Ollama: <code style="color: #0ff;">ollama serve</code>
            </div>
        `;
    }
}

// Send message to Ollama
async function sendOllamaMessage() {
    const input = document.getElementById('ollama-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Clear input
    input.value = '';
    
    // Get selected model
    const modelSelect = document.getElementById('ollama-model-dropdown');
    currentOllamaModel = modelSelect ? modelSelect.value : 'llama3';
    
    // Add user message to chat
    addOllamaChatMessage('user', message);
    
    // Add thinking indicator
    const thinkingId = addOllamaChatMessage('assistant', 'ü§î Thinking...', true);
    
    // Prepare messages
    ollamaMessages.push({
        role: 'user',
        content: message
    });
    
    try {
        const response = await fetch('/api/ollama/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: currentOllamaModel,
                messages: ollamaMessages
            })
        });
        
        const data = await response.json();
        
        // Remove thinking indicator
        document.getElementById(thinkingId)?.remove();
        
        // Add AI response
        const aiMessage = data.message?.content || data.response || 'No response';
        addOllamaChatMessage('assistant', aiMessage);
        
        // Add to history
        ollamaMessages.push({
            role: 'assistant',
            content: aiMessage
        });
        
        log('Ollama responded', 'info');
    } catch (error) {
        document.getElementById(thinkingId)?.remove();
        addOllamaChatMessage('system', `Error: ${error.message}`);
        log(`Ollama error: ${error.message}`, 'error');
    }
}

// Add message to chat UI
function addOllamaChatMessage(role, content, isTemp = false) {
    const messagesDiv = document.getElementById('ollama-chat-messages');
    const messageId = `msg-${Date.now()}`;
    
    let bgColor, textColor, icon;
    
    if (role === 'user') {
        bgColor = 'rgba(0, 50, 100, 0.3)';
        textColor = '#0ff';
        icon = 'üë§';
    } else if (role === 'assistant') {
        bgColor = 'rgba(0, 100, 0, 0.3)';
        textColor = '#0f0';
        icon = 'ü§ñ';
    } else {
        bgColor = 'rgba(100, 0, 0, 0.3)';
        textColor = '#f00';
        icon = '‚ö†Ô∏è';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.style.cssText = `
        margin-bottom: 10px;
        padding: 8px;
        background: ${bgColor};
        border-left: 3px solid ${textColor};
        border-radius: 3px;
    `;
    
    messageDiv.innerHTML = `
        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 3px;">
            ${icon} <strong style="color: ${textColor};">${role.toUpperCase()}</strong>
        </div>
        <div style="color: ${textColor}; white-space: pre-wrap; word-wrap: break-word;">
            ${escapeHtml(content)}
        </div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    return messageId;
}

// Clear chat
function clearOllamaChat() {
    ollamaMessages = [];
    document.getElementById('ollama-chat-messages').innerHTML = `
        <div style="text-align: center; opacity: 0.7; padding: 10px;">
            Chat cleared. Start a new conversation!
        </div>
    `;
}

// Enter key to send
document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('ollama-chat-input');
    if (input) {
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendOllamaMessage();
            }
        });
    }
});

// Helper function
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<style>
/* Chat scrollbar styling */
#ollama-chat-messages::-webkit-scrollbar {
    width: 8px;
}

#ollama-chat-messages::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.5);
}

#ollama-chat-messages::-webkit-scrollbar-thumb {
    background: #0f0;
    border-radius: 4px;
}

#ollama-chat-messages::-webkit-scrollbar-thumb:hover {
    background: #0ff;
}
</style>
