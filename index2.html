<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX DOOM Server Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght:400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Orbitron', 'Courier New', monospace;
            background: #000;
            color: #0f0;
            overflow-x: hidden;
        }
        
        /* Scanline effect */
        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 0, 0.03) 0px,
                transparent 1px,
                transparent 2px,
                rgba(0, 255, 0, 0.03) 3px
            );
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 2px solid #0f0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        
        .logo {
            font-size: 24px;
            font-weight: 900;
            text-shadow: 0 0 10px #0f0;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        .status-item {
            padding: 5px 10px;
            border: 1px solid #0f0;
            border-radius: 3px;
        }
        
        .status-online { color: #0f0; }
        .status-offline { color: #f00; }
        
        /* Main Container */
        .container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Panel Styles */
        .panel {
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #0f0;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            border-bottom: 1px solid #0f0;
            padding-bottom: 10px;
        }
        
        /* Servers List */
        .server-item {
            background: rgba(0, 40, 0, 0.5);
            border: 1px solid #0f0;
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .server-info {
            flex: 1;
        }
        
        .server-port {
            font-weight: bold;
            color: #0ff;
        }
        
        .server-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .server-status.running {
            background: #0f0;
            box-shadow: 0 0 5px #0f0;
        }
        
        .server-status.stopped {
            background: #f00;
            box-shadow: 0 0 5px #f00;
        }
        
        /* Buttons */
        .btn {
            background: transparent;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 8px 16px;
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn:hover {
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .btn-danger {
            border-color: #f00;
            color: #f00;
        }
        
        .btn-danger:hover {
            background: rgba(255, 0, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        /* Terminal */
        .terminal {
            background: #000;
            border: 2px solid #0f0;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .terminal-line {
            margin: 3px 0;
            color: #0f0;
        }
        
        .terminal-line.error {
            color: #f00;
        }
        
        .terminal-line.info {
            color: #0ff;
        }
        
        /* Marketplace */
        .module-item {
            background: rgba(0, 40, 0, 0.5);
            border: 1px solid #0f0;
            border-radius: 3px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .module-item:hover {
            background: rgba(0, 60, 0, 0.7);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .module-icon {
            font-size: 32px;
            float: left;
            margin-right: 15px;
        }
        
        .module-info {
            overflow: hidden;
        }
        
        .module-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .module-price {
            color: #ff0;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* Loading Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="scanline"></div>
    
    <!-- Header -->
    <div class="header">
        <div class="logo">‚ö° ASX DOOM SERVER ‚ö°</div>
        <div class="status-bar">
            <div class="status-item">
                <span>WebSocket:</span>
                <span id="ws-status" class="status-offline">OFFLINE</span>
            </div>
            <div class="status-item">
                <span>Ollama:</span>
                <span id="ollama-status" class="status-offline">OFFLINE</span>
            </div>
            <div class="status-item">
                <span>ASX Tokens:</span>
                <span id="token-balance">100.00</span> ü™ô
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Top Grid -->
        <div class="grid">
            <!-- Active Servers -->
            <div class="panel">
                <div class="panel-title">üñ•Ô∏è Active JSON Servers</div>
                <div id="servers-list">
                    <p style="opacity: 0.7">No servers running. Click "CREATE SERVER" to start.</p>
                </div>
                <button class="btn" onclick="createServer()" style="margin-top: 10px; width: 100%;">
                    ‚ûï CREATE NEW SERVER
                </button>
            </div>
            
            <!-- Ollama Integration -->
            <div class="panel">
                <div class="panel-title">ü§ñ Ollama LLM Connection</div>
                <p style="margin-bottom: 10px; opacity: 0.8">
                    Connect your local Ollama instance for AI-powered features.
                </p>
                <button class="btn" onclick="connectOllama()" style="width: 100%; margin-bottom: 10px;">
                    üîå CONNECT TO OLLAMA
                </button>
                <div id="ollama-models" style="font-size: 12px; opacity: 0.7;">
                    Not connected
                </div>
            </div>
            
            <!-- Module Marketplace -->
            <div class="panel">
                <div class="panel-title">üõí Module Marketplace</div>
                <div id="marketplace" style="max-height: 300px; overflow-y: auto;">
                    <p class="loading">Loading modules...</p>
                </div>
            </div>
        </div>
        
        <!-- Terminal Log -->
        <div class="panel">
            <div class="panel-title">üíª System Terminal</div>
            <div class="terminal" id="terminal">
                <div class="terminal-line">[SYSTEM] ASX DOOM JSON Server initialized</div>
                <div class="terminal-line">[SYSTEM] Ready to manage servers...</div>
            </div>
        </div>
    </div>
    
    <script>
        // Global State
        let ws = null;
        let servers = [];
        let modules = [];
        let tokenBalance = 100.00;
        
        // Initialize
        window.addEventListener('load', () => {
            connectWebSocket();
            loadMarketplace();
            loadTokenBalance();
        });
        
        // WebSocket Connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                updateStatus('ws-status', 'ONLINE', true);
                log('WebSocket connected', 'info');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWSMessage(data);
            };
            
            ws.onclose = () => {
                updateStatus('ws-status', 'OFFLINE', false);
                log('WebSocket disconnected', 'error');
                // Attempt reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                log('WebSocket error', 'error');
            };
        }
        
        // Handle WebSocket Messages
        function handleWSMessage(data) {
            switch(data.type) {
                case 'status':
                    servers = data.servers || [];
                    renderServers();
                    if (data.ollama) {
                        updateStatus('ollama-status', 'ONLINE', true);
                    }
                    break;
                    
                case 'server_created':
                    log(`Server created on port ${data.port}`, 'info');
                    fetchServers();
                    break;
                    
                case 'server_stopped':
                    log(`Server stopped: ${data.serverId}`, 'info');
                    fetchServers();
                    break;
                    
                case 'ollama_connected':
                    updateStatus('ollama-status', 'ONLINE', true);
                    renderOllamaModels(data.models);
                    break;
            }
        }
        
        // Create New Server
        async function createServer() {
            log('Creating new JSON server...', 'info');
            
            try {
                const response = await fetch('/api/servers/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`Server created: ${data.server.url}`, 'info');
                } else {
                    log(`Failed to create server: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error creating server: ${error.message}`, 'error');
            }
        }
        
        // Connect to Ollama
        async function connectOllama() {
            log('Connecting to Ollama...', 'info');
            
            try {
                const response = await fetch('/api/ollama/connect', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`Ollama connected! Found ${data.models.length} models`, 'info');
                    updateStatus('ollama-status', 'ONLINE', true);
                    renderOllamaModels(data.models);
                } else {
                    log(data.error, 'error');
                }
            } catch (error) {
                log(`Ollama connection failed: ${error.message}`, 'error');
            }
        }
        
        // Fetch Servers List
        async function fetchServers() {
            try {
                const response = await fetch('/api/servers');
                const data = await response.json();
                servers = data.servers || [];
                renderServers();
            } catch (error) {
                log(`Error fetching servers: ${error.message}`, 'error');
            }
        }
        
        // Render Servers
        function renderServers() {
            const container = document.getElementById('servers-list');
            
            if (servers.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7">No servers running. Click "CREATE SERVER" to start.</p>';
                return;
            }
            
            container.innerHTML = servers.map(server => `
                <div class="server-item">
                    <div class="server-info">
                        <div>
                            <span class="server-status ${server.status}"></span>
                            <span class="server-port">localhost:${server.port}</span>
                        </div>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                            Requests: ${server.requestCount} | Created: ${new Date(server.created).toLocaleTimeString()}
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="stopServer('${server.id}')">
                        STOP
                    </button>
                </div>
            `).join('');
        }
        
        // Stop Server
        async function stopServer(serverId) {
            try {
                const response = await fetch(`/api/servers/${serverId}/stop`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log(`Server ${serverId} stopped`, 'info');
                }
            } catch (error) {
                log(`Error stopping server: ${error.message}`, 'error');
            }
        }
        
        // Load Marketplace
        async function loadMarketplace() {
            try {
                const response = await fetch('/api/marketplace/modules');
                const data = await response.json();
                modules = data.modules || [];
                renderMarketplace();
            } catch (error) {
                log(`Error loading marketplace: ${error.message}`, 'error');
            }
        }
        
        // Render Marketplace
        function renderMarketplace() {
            const container = document.getElementById('marketplace');
            
            container.innerHTML = modules.map(module => `
                <div class="module-item" onclick="purchaseModule('${module.id}')">
                    <div class="module-icon">${module.icon}</div>
                    <div class="module-info">
                        <div class="module-name">${module.name}</div>
                        <div style="font-size: 12px; opacity: 0.8;">${module.description}</div>
                        <div class="module-price">${module.price.toFixed(2)} ASX</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Purchase Module
        async function purchaseModule(moduleId) {
            const module = modules.find(m => m.id === moduleId);
            if (!module) return;
            
            if (tokenBalance < module.price) {
                log(`Insufficient ASX tokens! Need ${module.price}, have ${tokenBalance}`, 'error');
                return;
            }
            
            const confirm = window.confirm(`Purchase ${module.name} for ${module.price} ASX?`);
            if (!confirm) return;
            
            // Deduct tokens (in production, this would be a blockchain transaction)
            tokenBalance -= module.price;
            document.getElementById('token-balance').textContent = tokenBalance.toFixed(2);
            
            log(`Purchased ${module.name} for ${module.price} ASX!`, 'info');
            log(`Module ${moduleId} installed successfully`, 'info');
        }
        
        // Load Token Balance
        async function loadTokenBalance() {
            try {
                const response = await fetch('/api/tokens/balance');
                const data = await response.json();
                tokenBalance = data.balance;
                document.getElementById('token-balance').textContent = tokenBalance.toFixed(2);
            } catch (error) {
                log(`Error loading balance: ${error.message}`, 'error');
            }
        }
        
        // Render Ollama Models
        function renderOllamaModels(models) {
            const container = document.getElementById('ollama-models');
            
            if (!models || models.length === 0) {
                container.innerHTML = 'No models found. Install with: ollama pull llama3';
                return;
            }
            
            container.innerHTML = '<strong>Available Models:</strong><br>' +
                models.map(m => `‚Ä¢ ${m.name}`).join('<br>');
        }
        
        // Update Status Indicator
        function updateStatus(id, text, online) {
            const element = document.getElementById(id);
            element.textContent = text;
            element.className = online ? 'status-online' : 'status-offline';
        }
        
        // Log to Terminal
        function log(message, type = 'info') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }
    </script>
</body>
</html>
